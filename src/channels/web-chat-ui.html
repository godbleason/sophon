<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sophon AI åŠ©æ‰‹</title>
  <style>
    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #242424;
      --bg-input: #1e1e1e;
      --text-primary: #e4e4e7;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --border: #2e2e2e;
      --user-bubble: #2563eb;
      --assistant-bubble: #262626;
      --success: #22c55e;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* é¡¶æ  */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .header-logo {
      font-size: 24px;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .header-status {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background 0.3s;
    }

    .status-dot.connected {
      background: var(--success);
    }

    /* æ¶ˆæ¯åŒºåŸŸ */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    /* æ¶ˆæ¯æ°”æ³¡ */
    .message {
      display: flex;
      gap: 12px;
      max-width: 80%;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.assistant {
      align-self: flex-start;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      background: var(--bg-tertiary);
    }

    .message.user .message-avatar {
      background: var(--user-bubble);
    }

    .message-content {
      padding: 10px 14px;
      border-radius: 12px;
      line-height: 1.6;
      font-size: 14px;
      word-break: break-word;
    }

    .message.user .message-content {
      background: var(--user-bubble);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-content pre {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-size: 13px;
    }

    .message-content code {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 13px;
    }

    .message-content p {
      margin: 4px 0;
    }

    .message-content p:first-child {
      margin-top: 0;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    /* æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ */
    .typing-indicator {
      display: none;
      align-self: flex-start;
      gap: 12px;
      max-width: 80%;
      animation: fadeIn 0.2s ease-out;
    }

    .typing-indicator.visible {
      display: flex;
    }

    .typing-dots {
      padding: 14px 18px;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-radius: 12px;
      border-bottom-left-radius: 4px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    /* æ¬¢è¿é¡µ */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 12px;
      color: var(--text-secondary);
    }

    .welcome-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .welcome h2 {
      font-size: 20px;
      color: var(--text-primary);
    }

    .welcome p {
      font-size: 14px;
      max-width: 400px;
      text-align: center;
      line-height: 1.5;
    }

    .welcome-commands {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .welcome-commands button {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .welcome-commands button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-area {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      max-width: 900px;
      margin: 0 auto;
    }

    .input-box {
      flex: 1;
      display: flex;
      align-items: center;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 9999px;
      transition: border-color 0.15s;
    }

    .input-box:focus-within {
      border-color: var(--accent);
    }

    .input-box textarea {
      flex: 1;
      background: transparent;
      border: none;
      padding: 12px 6px 12px 6px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      line-height: 1.5;
      max-height: 150px;
      min-height: 44px;
    }

    .input-box textarea::placeholder {
      color: var(--text-muted);
    }

    .send-btn-wrapper {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      padding: 0 6px 0 0;
    }

    .send-btn {
      width: 34px;
      height: 34px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .send-btn:hover {
      background: var(--accent-hover);
    }

    .send-btn:disabled {
      cursor: not-allowed;
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }

    /* èœå•æŒ‰é’®ï¼ˆè¾“å…¥æ¡†å†…å‰ç¼€ï¼‰ */
    .menu-container {
      position: relative;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      padding: 0 4px 0 6px;
    }

    .menu-btn {
      width: 34px;
      height: 34px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .menu-btn:hover {
      color: var(--accent);
      background: rgba(99, 102, 241, 0.15);
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      bottom: calc(100% + 12px);
      left: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px 0;
      min-width: 160px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      z-index: 100;
      animation: fadeIn 0.15s ease-out;
    }

    .menu-dropdown.visible {
      display: block;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .menu-item:hover {
      background: var(--bg-tertiary);
    }

    .menu-item .menu-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    /* è¿›åº¦æ­¥éª¤å®¹å™¨ */
    .progress-group {
      align-self: flex-start;
      max-width: 80%;
      animation: fadeIn 0.2s ease-out;
    }

    /* æŠ˜å å¤´éƒ¨ï¼ˆæ€è€ƒå®Œæˆåæ˜¾ç¤ºï¼‰ */
    .progress-header {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
    }

    .progress-header:hover {
      color: var(--text-secondary);
      border-color: var(--accent);
    }

    .progress-header .chevron {
      display: inline-block;
      transition: transform 0.2s;
      font-size: 10px;
    }

    .progress-group.collapsed .progress-header {
      display: flex;
    }

    .progress-group.collapsed .progress-header .chevron {
      transform: rotate(0deg);
    }

    .progress-group.expanded .progress-header {
      display: flex;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: none;
    }

    .progress-group.expanded .progress-header .chevron {
      transform: rotate(90deg);
    }

    .progress-steps {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      max-height: 300px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
    }

    .progress-steps::-webkit-scrollbar {
      width: 4px;
    }

    .progress-steps::-webkit-scrollbar-track {
      background: transparent;
    }

    .progress-steps::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* æŠ˜å çŠ¶æ€ï¼šéšè—æ­¥éª¤å†…å®¹ */
    .progress-group.collapsed .progress-steps {
      display: none;
    }

    /* å±•å¼€çŠ¶æ€ï¼šæ­¥éª¤æ˜¾ç¤ºå¹¶è¡”æ¥å¤´éƒ¨åœ†è§’ */
    .progress-group.expanded .progress-steps {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }

    .progress-step {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.5;
    }

    .progress-step-icon {
      flex-shrink: 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .progress-step-text {
      flex: 1;
      word-break: break-word;
    }

    .progress-step-text .tool-name {
      color: var(--accent);
      font-weight: 600;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
    }

    .progress-step-text .tool-args {
      display: block;
      color: var(--text-muted);
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px;
      margin-top: 2px;
      white-space: pre-wrap;
      max-height: 80px;
      overflow: hidden;
    }

    .progress-step-text .tool-result {
      display: block;
      color: var(--text-muted);
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px;
      margin-top: 2px;
      white-space: pre-wrap;
      max-height: 120px;
      overflow-y: auto;
      background: var(--bg-primary);
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .progress-step-text .tool-result.error {
      color: #f87171;
      border-color: #7f1d1d;
    }

    .progress-step.active .progress-step-icon {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* å“åº”å¼ */
    @media (max-width: 640px) {
      .message { max-width: 90%; }
      .progress-group { max-width: 90%; }
      .messages { padding: 12px; }
      .input-area { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="header-logo">ğŸ¤–</span>
    <span class="header-title">Sophon</span>
    <div class="header-status">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">è¿æ¥ä¸­...</span>
    </div>
  </div>

  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-icon">ğŸ¤–</div>
      <h2>Sophon AI åŠ©æ‰‹</h2>
      <p>è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯ï¼Œæˆ‘å¯ä»¥å¸®ä½ å›ç­”é—®é¢˜ã€æ‰§è¡Œå‘½ä»¤ã€è¯»å†™æ–‡ä»¶ç­‰ã€‚</p>
      <div class="welcome-commands">
        <button onclick="sendQuickMessage('/help')">ğŸ“– å¸®åŠ©</button>
        <button onclick="sendQuickMessage('/tools')">ğŸ”§ å·¥å…·åˆ—è¡¨</button>
        <button onclick="sendQuickMessage('/status')">ğŸ“Š çŠ¶æ€</button>
        <button onclick="sendQuickMessage('ä½ å¥½ï¼Œä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±')">ğŸ‘‹ æ‰“æ‹›å‘¼</button>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="message-avatar">ğŸ¤–</div>
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <div class="input-box">
        <div class="menu-container">
          <button class="menu-btn" id="menuBtn" title="èœå•">â˜°</button>
          <div class="menu-dropdown" id="menuDropdown">
            <button class="menu-item" onclick="sendCommand('/help')">
              <span class="menu-icon">ğŸ“–</span>å¸®åŠ©
            </button>
            <button class="menu-item" onclick="sendCommand('/about')">
              <span class="menu-icon">ğŸŒŸ</span>å…³äºå¹³å°
            </button>
            <button class="menu-item" onclick="sendCommand('/tools')">
              <span class="menu-icon">ğŸ”§</span>å·¥å…·åˆ—è¡¨
            </button>
            <button class="menu-item" onclick="sendCommand('/status')">
              <span class="menu-icon">ğŸ“Š</span>çŠ¶æ€
            </button>
            <button class="menu-item" onclick="sendCommand('/whoami')">
              <span class="menu-icon">ğŸ‘¤</span>æˆ‘çš„èº«ä»½
            </button>
          </div>
        </div>
      <textarea
        id="messageInput"
        placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€, Shift+Enter æ¢è¡Œ)"
        rows="1"
      ></textarea>
        <div class="send-btn-wrapper">
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
        â†‘
      </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const typingIndicator = document.getElementById('typingIndicator');
    const welcomeEl = document.getElementById('welcome');

    let ws = null;
    let isWaiting = false;
    let currentProgressEl = null; // å½“å‰è¿›åº¦æ­¥éª¤å®¹å™¨

    // === æŒä¹…åŒ–å®¢æˆ·ç«¯èº«ä»½ ===
    function getClientId() {
      let id = localStorage.getItem('sophon_client_id');
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem('sophon_client_id', id);
      }
      return id;
    }
    const clientId = getClientId();

    // === WebSocket è¿æ¥ ===
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(protocol + '//' + location.host);

      ws.onopen = () => {
        // è¿æ¥åç«‹å³å‘é€èº«ä»½æ ‡è¯†ï¼Œè®©åç«¯æ¢å¤ session
        ws.send(JSON.stringify({ type: 'identify', clientId }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleServerMessage(data);
      };

      ws.onclose = () => {
        statusDot.classList.remove('connected');
        statusText.textContent = 'å·²æ–­å¼€';
        sendBtn.disabled = true;
        setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        statusDot.classList.remove('connected');
        statusText.textContent = 'è¿æ¥é”™è¯¯';
      };
    }

    function handleServerMessage(data) {
      switch (data.type) {
        case 'connected':
          statusDot.classList.add('connected');
          statusText.textContent = 'å·²è¿æ¥';
          sendBtn.disabled = false;
          inputEl.focus();
          // é‡è¿æ—¶å…ˆæ¸…ç©ºå·²æœ‰æ¶ˆæ¯ï¼Œé¿å…å†å²æ¶ˆæ¯é‡å¤è¿½åŠ 
          // ä¿ç•™ typingIndicatorï¼Œåªç§»é™¤å…¶ä»–å­å…ƒç´ 
          while (messagesEl.firstChild) {
            if (messagesEl.firstChild === typingIndicator) break;
            messagesEl.removeChild(messagesEl.firstChild);
          }
          currentProgressEl = null;
          progressStepCount = 0;
          // å¦‚æœæœåŠ¡ç«¯è¿”å›äº†å†å²æ¶ˆæ¯ï¼Œæ¢å¤æ˜¾ç¤º
          if (data.history && data.history.length > 0) {
            if (welcomeEl) welcomeEl.style.display = 'none';
            for (const msg of data.history) {
              // assistant æ¶ˆæ¯å¯èƒ½é™„å¸¦æ€ç»´é“¾æ­¥éª¤
              if (msg.role === 'assistant' && msg.thinkingSteps && msg.thinkingSteps.length > 0) {
                addCollapsedProgressGroup(msg.thinkingSteps);
              }
              addMessage(msg.role, msg.content);
            }
          } else if (welcomeEl) {
            // æ²¡æœ‰å†å²æ¶ˆæ¯æ—¶æ¢å¤æ¬¢è¿ç•Œé¢
            welcomeEl.style.display = '';
          }
          break;
        case 'progress':
          handleProgress(data);
          break;
        case 'response':
          hideTyping();
          finalizeProgress();
          isWaiting = false;
          addMessage('assistant', data.text);
          break;
      }
    }

    // === è¿›åº¦å±•ç¤º ===
    let progressStepCount = 0; // å½“å‰è¿›åº¦ç»„çš„æ­¥éª¤è®¡æ•°

    function ensureProgressGroup() {
      if (!currentProgressEl) {
        progressStepCount = 0;

        currentProgressEl = document.createElement('div');
        currentProgressEl.className = 'progress-group';

        // æŠ˜å å¤´éƒ¨ï¼ˆåˆå§‹éšè—ï¼Œå®Œæˆåæ˜¾ç¤ºï¼‰
        const headerEl = document.createElement('div');
        headerEl.className = 'progress-header';
        headerEl.innerHTML = '<span class="chevron">â–¶</span><span class="progress-summary">ğŸ§  æ€è€ƒè¿‡ç¨‹</span>';
        headerEl.addEventListener('click', () => {
          toggleProgressGroup(headerEl.parentElement);
        });
        currentProgressEl.appendChild(headerEl);

        // æ­¥éª¤å†…å®¹åŒº
        const stepsEl = document.createElement('div');
        stepsEl.className = 'progress-steps';
        currentProgressEl.appendChild(stepsEl);

        messagesEl.insertBefore(currentProgressEl, typingIndicator);
      }
      return currentProgressEl.querySelector('.progress-steps');
    }

    function toggleProgressGroup(groupEl) {
      if (!groupEl) return;
      if (groupEl.classList.contains('collapsed')) {
        groupEl.classList.remove('collapsed');
        groupEl.classList.add('expanded');
      } else if (groupEl.classList.contains('expanded')) {
        groupEl.classList.remove('expanded');
        groupEl.classList.add('collapsed');
      }
    }

    function handleProgress(data) {
      hideTyping();
      const stepsEl = ensureProgressGroup();

      // å°†ä¹‹å‰çš„ active æ­¥éª¤æ ‡è®°ä¸ºå®Œæˆ
      const prevActive = stepsEl.querySelector('.progress-step.active');
      if (prevActive) {
        prevActive.classList.remove('active');
        const icon = prevActive.querySelector('.progress-step-icon');
        if (icon && icon.textContent === 'â³') icon.textContent = 'âœ…';
      }

      switch (data.step) {
        case 'thinking': {
          progressStepCount++;
          const step = createStepEl('â³', 'æ­£åœ¨æ€è€ƒ...');
          step.classList.add('active');
          stepsEl.appendChild(step);
          break;
        }
        case 'tool_call': {
          progressStepCount++;
          const argsStr = data.toolArgs ? JSON.stringify(data.toolArgs, null, 2) : '';
          const textEl = document.createElement('span');
          textEl.className = 'progress-step-text';
          textEl.innerHTML = 'è°ƒç”¨å·¥å…· <span class="tool-name">' + escapeHtml(data.toolName) + '</span>'
            + (argsStr ? '<span class="tool-args">' + escapeHtml(truncate(argsStr, 200)) + '</span>' : '');
          const step = createStepElRaw('ğŸ”§', textEl);
          step.classList.add('active');
          step.dataset.toolCallId = data.toolCallId || '';
          stepsEl.appendChild(step);
          break;
        }
        case 'tool_result': {
          // æ‰¾åˆ°å¯¹åº” tool_call æ­¥éª¤æ›´æ–°
          const callStep = stepsEl.querySelector('[data-tool-call-id="' + (data.toolCallId || '') + '"]');
          if (callStep) {
            callStep.classList.remove('active');
            const icon = callStep.querySelector('.progress-step-icon');
            if (icon) icon.textContent = data.isError ? 'âŒ' : 'âœ…';
            // è¿½åŠ ç»“æœ
            const textEl = callStep.querySelector('.progress-step-text');
            if (textEl && data.content) {
              const resultEl = document.createElement('span');
              resultEl.className = 'tool-result' + (data.isError ? ' error' : '');
              resultEl.textContent = truncate(data.content, 500);
              textEl.appendChild(resultEl);
            }
          }
          break;
        }
        case 'llm_response': {
          if (data.content) {
            progressStepCount++;
            const step = createStepEl('ğŸ’¬', data.content);
            stepsEl.appendChild(step);
          }
          break;
        }
      }

      // æ€è€ƒè¿‡ç¨‹ä¸­ï¼Œå§‹ç»ˆæ»šåŠ¨åˆ°åº•éƒ¨
      stepsEl.scrollTop = stepsEl.scrollHeight;
      scrollToBottom();
    }

    function createStepEl(icon, text) {
      const step = document.createElement('div');
      step.className = 'progress-step';
      step.innerHTML = '<span class="progress-step-icon">' + icon + '</span>'
        + '<span class="progress-step-text">' + escapeHtml(text) + '</span>';
      return step;
    }

    function createStepElRaw(icon, contentEl) {
      const step = document.createElement('div');
      step.className = 'progress-step';
      const iconEl = document.createElement('span');
      iconEl.className = 'progress-step-icon';
      iconEl.textContent = icon;
      step.appendChild(iconEl);
      step.appendChild(contentEl);
      return step;
    }

    /**
     * ä»å†å²æ•°æ®ä¸­åˆ›å»ºä¸€ä¸ªå·²æŠ˜å çš„æ€ç»´é“¾ç»„ï¼ˆåˆ·æ–°é¡µé¢åæ¢å¤ç”¨ï¼‰
     */
    function addCollapsedProgressGroup(thinkingSteps) {
      const groupEl = document.createElement('div');
      groupEl.className = 'progress-group collapsed';

      // æŠ˜å å¤´éƒ¨
      const headerEl = document.createElement('div');
      headerEl.className = 'progress-header';

      // ç»Ÿè®¡å·¥å…·è°ƒç”¨
      const toolCalls = thinkingSteps.filter(s => s.type === 'tool_call');
      const toolCount = toolCalls.length;
      let summaryText = 'ğŸ§  æ€è€ƒè¿‡ç¨‹';
      if (toolCount > 0) {
        const uniqueNames = [...new Set(toolCalls.map(s => s.toolName).filter(Boolean))];
        summaryText += ' Â· ' + toolCount + ' æ¬¡å·¥å…·è°ƒç”¨'
          + (uniqueNames.length > 0 ? ' (' + uniqueNames.join(', ') + ')' : '');
      } else {
        summaryText += ' Â· ' + thinkingSteps.length + ' æ­¥';
      }

      headerEl.innerHTML = '<span class="chevron">â–¶</span><span class="progress-summary">'
        + escapeHtml(summaryText) + '</span>';
      headerEl.addEventListener('click', () => {
        toggleProgressGroup(headerEl.parentElement);
      });
      groupEl.appendChild(headerEl);

      // æ­¥éª¤å†…å®¹åŒº
      const stepsEl = document.createElement('div');
      stepsEl.className = 'progress-steps';

      for (const step of thinkingSteps) {
        if (step.type === 'tool_call') {
          const textEl = document.createElement('span');
          textEl.className = 'progress-step-text';
          textEl.innerHTML = 'è°ƒç”¨å·¥å…· <span class="tool-name">' + escapeHtml(step.toolName || '') + '</span>'
            + (step.toolArgs ? '<span class="tool-args">' + escapeHtml(truncate(step.toolArgs, 200)) + '</span>' : '');
          const stepEl = createStepElRaw('ğŸ”§', textEl);
          stepsEl.appendChild(stepEl);
        } else if (step.type === 'tool_result') {
          const icon = step.isError ? 'âŒ' : 'âœ…';
          const textEl = document.createElement('span');
          textEl.className = 'progress-step-text';
          let html = escapeHtml(step.toolName || 'å·¥å…·ç»“æœ');
          if (step.content) {
            html += '<span class="tool-result' + (step.isError ? ' error' : '') + '">'
              + escapeHtml(truncate(step.content, 500)) + '</span>';
          }
          textEl.innerHTML = html;
          const stepEl = createStepElRaw(icon, textEl);
          stepsEl.appendChild(stepEl);
        }
      }

      groupEl.appendChild(stepsEl);
      messagesEl.insertBefore(groupEl, typingIndicator);
    }

    function finalizeProgress() {
      if (currentProgressEl) {
        // æ ‡è®°æ‰€æœ‰ active ä¸ºå®Œæˆ
        const actives = currentProgressEl.querySelectorAll('.progress-step.active');
        actives.forEach(el => {
          el.classList.remove('active');
          const icon = el.querySelector('.progress-step-icon');
          if (icon && icon.textContent === 'â³') icon.textContent = 'âœ…';
        });

        // ç»Ÿè®¡å·¥å…·è°ƒç”¨æ•°é‡ç”¨äºæ‘˜è¦
        const toolSteps = currentProgressEl.querySelectorAll('.progress-step [data-tool-call-id]').length
          || currentProgressEl.querySelectorAll('.progress-step').length;
        const summaryEl = currentProgressEl.querySelector('.progress-summary');
        if (summaryEl) {
          const toolCalls = currentProgressEl.querySelectorAll('[data-tool-call-id]');
          const toolCount = toolCalls.length;
          if (toolCount > 0) {
            // æ”¶é›†å·¥å…·åç§°
            const toolNames = [];
            toolCalls.forEach(el => {
              const nameEl = el.querySelector('.tool-name');
              if (nameEl) toolNames.push(nameEl.textContent);
            });
            const uniqueNames = [...new Set(toolNames)];
            summaryEl.textContent = 'ğŸ§  æ€è€ƒè¿‡ç¨‹ Â· ' + toolCount + ' æ¬¡å·¥å…·è°ƒç”¨'
              + (uniqueNames.length > 0 ? ' (' + uniqueNames.join(', ') + ')' : '');
          } else {
            summaryEl.textContent = 'ğŸ§  æ€è€ƒè¿‡ç¨‹ Â· ' + progressStepCount + ' æ­¥';
          }
        }

        // è‡ªåŠ¨æŠ˜å 
        currentProgressEl.classList.add('collapsed');

        currentProgressEl = null;
        progressStepCount = 0;
      }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function truncate(str, max) {
      if (str.length <= max) return str;
      return str.substring(0, max) + '...';
    }

    // === æ¶ˆæ¯å‘é€ ===
    function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || !ws || ws.readyState !== WebSocket.OPEN || isWaiting) return;

      // éšè—æ¬¢è¿é¡µ
      if (welcomeEl) welcomeEl.style.display = 'none';

      addMessage('user', text);
      ws.send(JSON.stringify({ type: 'message', text }));

      inputEl.value = '';
      inputEl.style.height = 'auto';
      isWaiting = true;
      showTyping();
    }

    function sendQuickMessage(text) {
      inputEl.value = text;
      sendMessage();
    }

    // === èœå• ===
    const menuBtn = document.getElementById('menuBtn');
    const menuDropdown = document.getElementById('menuDropdown');

    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle('visible');
    });

    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
    document.addEventListener('click', () => {
      menuDropdown.classList.remove('visible');
    });

    function sendCommand(cmd) {
      menuDropdown.classList.remove('visible');
      sendQuickMessage(cmd);
    }

    // === UI è¾…åŠ© ===
    function addMessage(role, text) {
      const msgEl = document.createElement('div');
      msgEl.className = 'message ' + role;

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = formatMessage(text);

      msgEl.appendChild(avatar);
      msgEl.appendChild(content);

      // æ’å…¥åˆ° typing indicator ä¹‹å‰
      messagesEl.insertBefore(msgEl, typingIndicator);
      scrollToBottom();
    }

    function formatMessage(text) {
      // ä»£ç å—
      text = text.replace(/```(\w*)?\\n([\\s\\S]*?)```/g, '<pre><code>$2</code></pre>');
      // è¡Œå†…ä»£ç 
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      // ç²—ä½“
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // æ¢è¡Œ
      text = text.replace(/\n/g, '<br>');
      return text;
    }

    function showTyping() {
      typingIndicator.classList.add('visible');
      scrollToBottom();
    }

    function hideTyping() {
      typingIndicator.classList.remove('visible');
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    // === è¾“å…¥æ¡†å¤„ç† ===
    let isComposing = false; // è¾“å…¥æ³•ç»„åˆçŠ¶æ€

    inputEl.addEventListener('compositionstart', () => { isComposing = true; });
    inputEl.addEventListener('compositionend', () => { isComposing = false; });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });

    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
    });

    // === å¯åŠ¨ ===
    connect();
  </script>
</body>
</html>
